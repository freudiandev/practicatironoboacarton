/**
 * REPARACI√ìN R√ÅPIDA DE EMERGENCIA
 * Soluciona todos los problemas cr√≠ticos de carga detectados
 */

console.log('üö® === REPARACI√ìN R√ÅPIDA DE EMERGENCIA ACTIVADA ===');

class EmergencyRepair {
  constructor() {
    this.repairs = [];
    this.startTime = Date.now();
    
    console.log('üîß Iniciando reparaci√≥n de emergencia...');
    this.runAllRepairs();
  }
  
  async runAllRepairs() {
    // 1. Reparar Learning Memory si no est√° disponible
    await this.repairLearningMemory();
    
    // 2. Reparar carga del juego principal
    await this.repairGameLoading();
    
    // 3. Inicializar sistemas de voz si no est√°n activos
    await this.initializeVoiceSystems();
    
    // 4. Verificar canvas y controles
    await this.repairCanvasAndControls();
    
    // 5. Reportar resultados
    this.generateRepairReport();
    
    // 6. Ejecutar validaci√≥n post-reparaci√≥n
    setTimeout(() => {
      this.postRepairValidation();
    }, 2000);
  }
  
  async repairLearningMemory() {
    console.log('üß† Reparando Learning Memory...');
    
    if (!window.learningMemory) {
      if (typeof AdvancedLearningMemorySystem === 'function') {
        try {
          window.learningMemory = new AdvancedLearningMemorySystem();
          this.repairs.push('‚úÖ Learning Memory inicializado exitosamente');
          console.log('‚úÖ Learning Memory reparado y operativo');
        } catch (error) {
          this.repairs.push(`‚ùå Error al inicializar Learning Memory: ${error.message}`);
          console.error('‚ùå Error al reparar Learning Memory:', error);
        }
      } else {
        this.repairs.push('‚ö†Ô∏è Clase AdvancedLearningMemorySystem no disponible');
        console.warn('‚ö†Ô∏è Clase AdvancedLearningMemorySystem no encontrada');
      }
    } else {
      this.repairs.push('‚úÖ Learning Memory ya estaba operativo');
      console.log('‚úÖ Learning Memory ya operativo');
    }
  }
  
  async repairGameLoading() {
    console.log('üéÆ Verificando carga del juego principal...');
    
    if (!window.unifiedGame) {
      // Verificar si el script del juego se carg√≥ correctamente
      const scripts = document.querySelectorAll('script[src*="DOOM"]');
      let doomScriptFound = false;
      
      scripts.forEach(script => {
        if (script.src.includes('DOOM-LIMPIO.js') || script.src.includes('DOOM-UNIFICADO.js')) {
          doomScriptFound = true;
        }
      });
      
      if (doomScriptFound) {
        this.repairs.push('‚ö†Ô∏è Script del juego cargado pero window.unifiedGame no disponible');
        console.warn('‚ö†Ô∏è Script cargado pero juego no inicializado');
        
        // Intentar forzar inicializaci√≥n si la funci√≥n existe
        if (typeof initializeUnifiedGame === 'function') {
          try {
            initializeUnifiedGame();
            this.repairs.push('üîß Inicializaci√≥n del juego forzada');
          } catch (error) {
            this.repairs.push(`‚ùå Error al forzar inicializaci√≥n: ${error.message}`);
          }
        }
      } else {
        this.repairs.push('‚ùå Script del juego no encontrado');
        console.error('‚ùå No se encontr√≥ script del juego principal');
      }
    } else {
      this.repairs.push('‚úÖ Juego principal ya cargado');
      console.log('‚úÖ Juego principal operativo');
    }
  }
  
  async initializeVoiceSystems() {
    console.log('ü§ñ Inicializando sistemas de voz...');
    
    // Verificar sistema de voz extendido
    if (!window.learningMemoryVoice) {
      if (typeof LearningMemoryVoice === 'function') {
        try {
          window.learningMemoryVoice = new LearningMemoryVoice();
          this.repairs.push('‚úÖ Sistema de voz extendido inicializado');
        } catch (error) {
          this.repairs.push(`‚ùå Error al inicializar sistema de voz: ${error.message}`);
        }
      } else {
        this.repairs.push('‚ö†Ô∏è Clase LearningMemoryVoice no disponible');
      }
    } else {
      this.repairs.push('‚úÖ Sistema de voz ya operativo');
    }
    
    // Verificar integrador de voz
    if (!window.voiceIntegrator) {
      if (typeof VoiceSystemIntegrator === 'function') {
        try {
          window.voiceIntegrator = new VoiceSystemIntegrator();
          this.repairs.push('‚úÖ Integrador de voz inicializado');
        } catch (error) {
          this.repairs.push(`‚ùå Error al inicializar integrador: ${error.message}`);
        }
      } else {
        this.repairs.push('‚ö†Ô∏è Clase VoiceSystemIntegrator no disponible');
      }
    } else {
      this.repairs.push('‚úÖ Integrador de voz ya operativo');
    }
    
    // Verificar sistema de emergencia
    if (!window.emergencySystem) {
      if (typeof EmergencyAutoCorrection === 'function') {
        try {
          window.emergencySystem = new EmergencyAutoCorrection();
          this.repairs.push('‚úÖ Sistema de emergencia inicializado');
        } catch (error) {
          this.repairs.push(`‚ùå Error al inicializar sistema de emergencia: ${error.message}`);
        }
      } else {
        this.repairs.push('‚ö†Ô∏è Clase EmergencyAutoCorrection no disponible');
      }
    } else {
      this.repairs.push('‚úÖ Sistema de emergencia ya operativo');
    }
  }
  
  async repairCanvasAndControls() {
    console.log('üé® Verificando canvas y controles...');
    
    // Verificar canvas
    const canvas = document.getElementById('gameCanvas');
    if (!canvas) {
      // Crear canvas si no existe
      const newCanvas = document.createElement('canvas');
      newCanvas.id = 'gameCanvas';
      newCanvas.width = 800;
      newCanvas.height = 600;
      newCanvas.style.cssText = `
        width: 800px;
        height: 600px;
        border: 1px solid #333;
        background: #000;
        cursor: crosshair;
      `;
      document.body.appendChild(newCanvas);
      
      this.repairs.push('üîß Canvas recreado exitosamente');
      console.log('üîß Canvas recreado');
    } else {
      // Verificar contexto 2D
      const ctx = canvas.getContext('2d');
      if (ctx) {
        this.repairs.push('‚úÖ Canvas y contexto 2D operativos');
        console.log('‚úÖ Canvas operativo');
      } else {
        this.repairs.push('‚ùå Contexto 2D no disponible');
        console.error('‚ùå Contexto 2D no disponible');
      }
    }
  }
  
  generateRepairReport() {
    const endTime = Date.now();
    const duration = endTime - this.startTime;
    
    console.log('\n' + '='.repeat(60));
    console.log('üîß REPORTE DE REPARACI√ìN DE EMERGENCIA');
    console.log('='.repeat(60));
    console.log(`‚è±Ô∏è Duraci√≥n: ${duration}ms`);
    console.log(`üîß Reparaciones realizadas: ${this.repairs.length}`);
    console.log('\nüìã DETALLES DE REPARACI√ìN:');
    
    this.repairs.forEach(repair => {
      console.log(`  ${repair}`);
    });
    
    // Evaluar estado general
    const successRepairs = this.repairs.filter(r => r.includes('‚úÖ')).length;
    const errorRepairs = this.repairs.filter(r => r.includes('‚ùå')).length;
    const warningRepairs = this.repairs.filter(r => r.includes('‚ö†Ô∏è')).length;
    
    let status;
    if (errorRepairs === 0 && warningRepairs === 0) {
      status = 'üéâ REPARACI√ìN PERFECTA - Todos los sistemas operativos';
    } else if (errorRepairs === 0) {
      status = '‚úÖ REPARACI√ìN EXITOSA - Advertencias menores';
    } else if (errorRepairs <= 2) {
      status = '‚ö†Ô∏è REPARACI√ìN PARCIAL - Algunos errores persistentes';
    } else {
      status = 'üö® REPARACI√ìN INCOMPLETA - M√∫ltiples errores cr√≠ticos';
    }
    
    console.log(`\nüèÅ RESULTADO FINAL: ${status}`);
    console.log(`‚úÖ √âxitos: ${successRepairs} | ‚ùå Errores: ${errorRepairs} | ‚ö†Ô∏è Advertencias: ${warningRepairs}`);
    
    // Registrar en Learning Memory si est√° disponible
    if (window.learningMemory && window.learningMemory.registerEvent) {
      window.learningMemory.registerEvent({
        type: 'EMERGENCY_REPAIR',
        action: 'COMPLETE_SYSTEM_REPAIR',
        description: status,
        details: {
          duration: duration,
          successRepairs: successRepairs,
          errorRepairs: errorRepairs,
          warningRepairs: warningRepairs,
          repairs: this.repairs
        },
        timestamp: Date.now(),
        preserve: true
      });
    }
    
    console.log('\nüîÑ Reparaci√≥n completada. Iniciando validaci√≥n...');
  }
  
  postRepairValidation() {
    console.log('\nüîç === VALIDACI√ìN POST-REPARACI√ìN ===');
    
    const validations = {
      learningMemory: !!window.learningMemory,
      voiceSystem: !!window.learningMemoryVoice,
      voiceIntegrator: !!window.voiceIntegrator,
      emergencySystem: !!window.emergencySystem,
      gameSystem: !!window.unifiedGame,
      canvas: !!document.getElementById('gameCanvas')
    };
    
    const validCount = Object.values(validations).filter(Boolean).length;
    const totalCount = Object.keys(validations).length;
    
    console.log('üìä ESTADO DE SISTEMAS POST-REPARACI√ìN:');
    Object.entries(validations).forEach(([system, isValid]) => {
      const status = isValid ? '‚úÖ' : '‚ùå';
      console.log(`  ${status} ${system}: ${isValid ? 'OPERATIVO' : 'NO DISPONIBLE'}`);
    });
    
    console.log(`\nüìà EFECTIVIDAD DE REPARACI√ìN: ${validCount}/${totalCount} (${(validCount/totalCount*100).toFixed(1)}%)`);
    
    if (validCount === totalCount) {
      console.log('üéâ ¬°TODOS LOS SISTEMAS REPARADOS Y OPERATIVOS!');
      
      // Activar monitoreo si est√° disponible
      if (window.learningMemoryVoice && window.learningMemoryVoice.voiceReport) {
        window.learningMemoryVoice.voiceReport(
          'success',
          'REPARACI√ìN DE EMERGENCIA COMPLETADA - Todos los sistemas operativos',
          { systemsRepaired: validCount, effectiveness: `${(validCount/totalCount*100).toFixed(1)}%` }
        );
      }
    } else {
      console.log('‚ö†Ô∏è Algunos sistemas requieren atenci√≥n adicional');
      
      if (window.learningMemoryVoice && window.learningMemoryVoice.voiceReport) {
        window.learningMemoryVoice.voiceReport(
          'warning',
          `REPARACI√ìN PARCIAL - ${validCount}/${totalCount} sistemas operativos`,
          { systemsOperational: validCount, systemsDown: totalCount - validCount }
        );
      }
    }
    
    console.log('='.repeat(60));
  }
}

// Ejecutar reparaci√≥n de emergencia inmediatamente
console.log('üö® Iniciando reparaci√≥n de emergencia en 1 segundo...');
setTimeout(() => {
  new EmergencyRepair();
}, 1000);

console.log('üîß Sistema de reparaci√≥n de emergencia cargado');
