<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DOOM: Noboa de Cart√≥n - Juego de Disparos</title>
  
  <!-- Favicon y iconos -->
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  
  <!-- Meta tags para SEO y redes sociales -->
  <meta name="description" content="Juego estilo DOOM con laberintos, enemigos y combate en primera persona. ¬°Explora, dispara y sobrevive!">
  <meta name="keywords" content="doom, juego, fps, laberinto, disparos, javascript, canvas">
  <meta name="author" content="Alex Rafael Almeida Orellana freudianDev">
  <!-- Sugerencia de no-cache para el documento HTML (los recursos externos se versionan con ?v=) -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  
  <!-- Open Graph para redes sociales -->
  <meta property="og:title" content="DOOM: Noboa de Cart√≥n">
  <meta property="og:description" content="Juego estilo DOOM con laberintos y combate en primera persona">
  <meta property="og:type" content="website">
  <meta property="og:image" content="thumbnail.jpeg">
  
  <!-- SISTEMA DE VERSIONADO AUTOM√ÅTICO - Se ejecuta PRIMERO -->
  <script src="auto-version.js"></script>
  
  <!-- Estilos separados por funcionalidad -->
  <link rel="stylesheet" href="styles.css?v=20250818">
  <link rel="stylesheet" href="css/layout.css?v=20250818">
  <link rel="stylesheet" href="css/menus.css?v=20250818">
  <link rel="stylesheet" href="css/game-ui.css?v=20250818">
  <link rel="stylesheet" href="css/effects.css?v=20250818">
  <!-- Estilos para m√≥vil y responsive avanzado -->
  <link rel="stylesheet" href="css/mobile.css?v=20250818">
</head>
<body>
  <!-- Men√∫ de inicio -->
  <div id="main-menu" class="menu-screen">
    <div class="menu-bunting" aria-hidden="true"></div>
    <div class="menu-backdrop-texture" aria-hidden="true"></div>
    <div class="menu-hero" aria-hidden="true"></div>
    <div class="menu-container">
      <div class="pins" aria-hidden="true"></div>
      <h1 class="game-title">DOOM: Noboa de Cart√≥n</h1>
      <div class="menu-buttons">
        <button id="start-btn" class="menu-btn">INICIAR PARTIDA</button>
        <button id="highscores-btn" class="menu-btn">PUNTAJES M√ÅS ALTOS</button>
        <button id="donate-btn" class="menu-btn">DONACIONES</button>
      </div>
      <footer class="menu-footer" aria-label="Sobre el desarrollador">
        <h2>Sobre el Desarrollador</h2>
        <p>Alex Almeida es un desarrollador independiente comprometido con la creaci√≥n de videojuegos que abordan temas sociales y pol√≠ticos relevantes.</p>
        <p>S√≠guelo en: <a href="https://www.instagram.com/freudiandev/" class="menu-footer-link" target="_blank" rel="noopener">@freudiandev</a></p>
      </footer>
    </div>
  </div>

  <!-- Pantalla de puntajes -->
  <div id="highscores-screen" class="menu-screen hidden">
    <div class="menu-container">
      <h1 class="game-title">MEJORES PUNTAJES</h1>
      <div id="highscores-list" class="highscores-list">
        <!-- Los puntajes se cargar√°n aqu√≠ -->
      </div>
      <button id="back-to-menu-btn" class="menu-btn">VOLVER AL MEN√ö</button>
      <footer class="menu-footer" aria-label="Sobre el desarrollador">
        <h2>Sobre el Desarrollador</h2>
        <p>Alex Almeida es un desarrollador independiente comprometido con la creaci√≥n de videojuegos que abordan temas sociales y pol√≠ticos relevantes.</p>
        <p>S√≠guelo en: <a href="https://www.instagram.com/freudiandev/" class="menu-footer-link" target="_blank" rel="noopener">@freudiandev</a></p>
      </footer>
    </div>
  </div>

  <!-- Pantalla de juego -->
  <div id="game-screen" class="hidden">
    <!-- Popup de captura de mouse -->
    <div id="mouse-capture-popup" class="mouse-capture-popup" role="dialog" aria-live="polite" aria-modal="false">
      <h3 id="mouse-capture-title">üéØ DOOM: Noboa de Cart√≥n</h3>
      <div class="click-icon" id="mouse-capture-icon">üñ±Ô∏è</div>
      <p id="mouse-capture-primary" class="mouse-capture-primary"><strong>Haz clic en la pantalla</strong></p>
      <p id="mouse-capture-secondary" class="mouse-capture-secondary">para capturar el mouse y comenzar a jugar.</p>
      <p id="mouse-capture-escape" class="mouse-capture-escape">Presiona <span>ESC</span> para liberar el cursor cuando quieras.</p>
    </div>
    
    <!-- Layout del juego -->
    <div class="game-layout-improved">
      <aside id="hud-panel-left" class="hud-panel side-left">
        <div class="hud-section hud-life">
          <div class="section-title">VITALIDAD</div>
          <div class="life-bar">
            <div id="player-health-bar" class="life-bar-fill"></div>
          </div>
          <div class="life-values">
            <span id="player-health-value">100</span>
            <span class="life-max">/100</span>
          </div>
        </div>

        <div class="hud-section hud-ammo">
          <div class="section-title">ARMAMENTO</div>
          <div class="info-row">
            <span>Munici√≥n</span>
            <span id="player-ammo">30</span>
          </div>
          <div class="info-row">
            <span>Cartuchos</span>
            <span id="player-magazines">6</span>
          </div>
        </div>

        <div class="hud-section hud-minimap">
          <div class="section-title">RADAR</div>
          <canvas id="hud-minimap" width="220" height="220" aria-label="Minimapa"></canvas>
          <div class="info-row coordinates">
            <span>Coordenadas</span>
            <span id="player-coordinates">0,0</span>
          </div>
        </div>

        <div class="hud-section hud-stats">
          <div class="section-title">ESTAD√çSTICAS</div>
          <div class="info-row">
            <span>Tiempo</span>
            <span id="hud-timer">0:00</span>
          </div>
          <div class="info-row">
            <span>Enemigos abatidos</span>
            <span id="hud-kills">0</span>
          </div>
          <div class="info-row">
            <span>Headshots</span>
            <span id="hud-headshots">0</span>
          </div>
        </div>
      </aside>

      <!-- Container del juego -->
      <div id="game-container"></div>
      
      <!-- HUD lateral derecho estilo cyberpunk -->
      <aside id="hud-panel" class="hud-panel side-right">
        <div class="hud-section hud-donation">
          <div class="section-title">DONACIONES</div>
          <div class="donation-qr-wrapper">
            <img src="qrPichincha.jpg" alt="QR Banco Pichincha a nombre de Samantha Ayleen Rueda Chamorro" class="donation-qr-image" role="button" tabindex="0" aria-haspopup="dialog" aria-controls="donation-qr-lightbox">
            <p class="donation-note">Escanea el c√≥digo QR con la app del Banco Pichincha para realizar tu aporte.</p>
          </div>
          <div class="donation-scroll">
            <p class="donation-text">
              <strong>Apoya al colectivo CiberPunk Ecuador</strong>: tu aporte impulsa nuevas intervenciones digitales, performance y videojuegos pol√≠ticos.
              ¬°Dona 50 centavos, 75 centavos o lo que puedas para mantener viva la resistencia pixelada!
              <span>Escanea el QR desde la app del banco o usa los datos directos de la cuenta.</span>
              <span>Si est√°s en el exterior y quieres apoyar, puedes enviar a mi PayPal:</span>
              <span><strong>samantharueda91@gmail.com</strong></span>
            </p>
            <div class="donation-bank-info">
              <p><strong>Banco Pichincha</strong> ¬∑ Cuenta de ahorro transaccional</p>
              <p>N√∫mero: <strong>2206684682</strong></p>
              <p>C√©dula: <strong>1723625032</strong></p>
              <p>Nombre: <strong>Samantha Ayleen Rueda Chamorro</strong></p>
              <p>Mensaje: Para sostener al colectivo <strong>CiberPunk Ecuador</strong>.</p>
            </div>
          </div>
        </div>
      </aside>
    </div>

    <div id="control-hints-overlay" class="control-hints-overlay hidden" aria-hidden="true">
      <div class="control-hints-card" role="dialog" aria-modal="false" aria-labelledby="control-hints-title">
        <h3 id="control-hints-title">Controles principales</h3>
        <div id="control-hints-content" class="control-hints-content"></div>
        <button type="button" class="control-hints-close" data-control-hints-dismiss>Entendido</button>
      </div>
    </div>

    <div id="donation-qr-lightbox" class="donation-qr-lightbox hidden" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="donation-qr-title">
      <div class="donation-qr-lightbox__content">
        <button type="button" class="donation-qr-close" data-donation-close>CERRAR</button>
        <img src="qrPichincha.jpg" alt="C√≥digo QR ampliado del Banco Pichincha para donaciones" class="donation-qr-lightbox__image" id="donation-qr-expanded">
        <p class="donation-qr-lightbox__title" id="donation-qr-title">Escanea el c√≥digo en tama√±o completo</p>
      </div>
    </div>

    <!-- Controles m√≥viles (aparecen solo en dispositivos t√°ctiles) -->
    <div id="mobile-controls" aria-label="Controles t√°ctiles" class="hidden" role="group">
      <div class="mc-left">
        <button class="mc-btn mc-w" data-key="KeyW" aria-label="Avanzar">W</button>
        <div class="mc-row">
          <button class="mc-btn mc-a" data-key="KeyA" aria-label="Izquierda">A</button>
          <button class="mc-btn mc-s" data-key="KeyS" aria-label="Atr√°s">S</button>
          <button class="mc-btn mc-d" data-key="KeyD" aria-label="Derecha">D</button>
        </div>
      </div>
      <div class="mc-right">
        <div class="mc-row">
          <button class="mc-btn mc-up" data-key="ArrowUp" aria-label="Cabeza arriba">‚Üë</button>
        </div>
        <div class="mc-row">
          <button class="mc-btn mc-left" data-key="ArrowLeft" aria-label="Cabeza izquierda">‚Üê</button>
          <button class="mc-btn mc-right" data-key="ArrowRight" aria-label="Cabeza derecha">‚Üí</button>
        </div>
        <div class="mc-row">
          <button class="mc-btn mc-down" data-key="ArrowDown" aria-label="Cabeza abajo">‚Üì</button>
        </div>
      </div>
      <button id="mc-shot" class="mc-shot" aria-label="Disparar">SHOT</button>
    </div>

    <!-- Overlay para rotar dispositivo a horizontal -->
    <div id="rotate-overlay" class="hidden" aria-live="assertive">
      <div class="rotate-card">
        <div class="rotate-icon">üì±‚Üª</div>
        <div class="rotate-text">Gira tu dispositivo a horizontal para jugar</div>
      </div>
    </div>
  </div>

  <!-- Precarga de sprites antes de iniciar el juego -->
  <div id="sprite-preload" style="position: fixed; left: -9999px; top: -9999px; visibility: hidden;">
    <!-- Cargar sprites desde la ra√≠z del proyecto -->
    <img src="noboa-casual.png?v=20250818" alt="Sprite casual" id="preload-casual">
    <img src="noboa-deportivo.png?v=20250818" alt="Sprite deportivo" id="preload-deportivo">
    <img src="noboa-presidencial.png?v=20250818" alt="Sprite presidencial" id="preload-presidencial">
  </div>

  <!-- SCRIPTS - ORDEN CR√çTICO CON DEBUG -->
  <!-- Definir versi√≥n global de assets antes de cualquier script -->
  <script>window.__ASSET_VERSION__ = '20250818';</script>
  <!-- Solo cargar el sistema de sprites necesario en producci√≥n -->
  <script src="enemy-sprites.js?v=20250818"></script>
  
  <!-- Sistemas de armas: efectos de balas y audio -->
  <script src="bullet-effects.js?v=20250818"></script>
  <script src="weapon-audio.js?v=20250818"></script>
  <script src="texture-atlas.js?v=20250818"></script>
  
  <!-- Test inmediato de sistemas de armas -->
  <script>
    console.log('üß™ Testeo inmediato de sistemas de armas...');
    console.log('BulletEffectsSystem:', typeof BulletEffectsSystem);
    console.log('WeaponAudioSystem:', typeof WeaponAudioSystem);
    
    // Test r√°pido de instanciaci√≥n
    try {
      const testBullets = new BulletEffectsSystem();
      console.log('‚úÖ BulletEffectsSystem instanciado correctamente');
    } catch (e) {
      console.error('‚ùå Error instanciando BulletEffectsSystem:', e);
    }
    
    try {
      const testAudio = new WeaponAudioSystem();
      console.log('‚úÖ WeaponAudioSystem instanciado correctamente');
    } catch (e) {
      console.error('‚ùå Error instanciando WeaponAudioSystem:', e);
    }
  </script>
  
  <!-- Carga condicional de utilidades de debug (deshabilitado por defecto) -->
  <script>
  window.__DEBUG_MODE__ = false; // Cambiar a true solo para depurar localmente
    if (window.__DEBUG_MODE__) {
      [
        'sprite-loader.js',
        'debug-system.js',
        'sprite-fixer.js',
        'sprite-tester.js',
        'doom-inspector.js'
      ].forEach(function(src) {
        var s = document.createElement('script');
    s.src = src + '?v=' + window.__ASSET_VERSION__;
        document.head.appendChild(s);
      });
    }
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.min.js" integrity="sha512-l9cEGoVYLRNvKcJsteVEh9UpAJZciV06P88eaJEqn3Ejj6inUeJ8V+RaH//RUW2KIiMzFxLpy0X58F3RrgPfGw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="assets/js/p5-centro-historico.js?v=20250818"></script>
  <!-- Luego cargar el juego y sus componentes -->
  <script src="game-all-in-one.js?v=20250818"></script>
  <script src="menu-manager.js?v=20250818"></script>
  <!-- Responsive y controles m√≥viles -->
  <script src="responsive.js?v=20250818"></script>
  <script src="mobile-controls.js?v=20250818"></script>

  <!-- Verificaci√≥n mejorada -->
  <script>
    console.log('üîç === VERIFICACI√ìN DE SISTEMAS ===');
  // Flag global para UI de depuraci√≥n (botones flotantes)
  const ENABLE_DEBUG_PANELS = false;
    
    // Verificaci√≥n de componentes cr√≠ticos
    console.log('- DoomGame disponible:', !!window.DoomGame ? '‚úÖ' : '‚ùå');
    console.log('- MenuManager disponible:', !!window.MenuManager ? '‚úÖ' : '‚ùå');
    console.log('- EnemySpriteSystem disponible:', !!window.EnemySpriteSystem ? '‚úÖ' : '‚ùå');
    console.log('- Precarga de sprites:', !!document.getElementById('sprite-preload') ? '‚úÖ' : '‚ùå');
    
    // Verificar si los elementos precargados se cargaron correctamente
    const preloadedImages = document.querySelectorAll('#sprite-preload img');
    console.log(`- Im√°genes precargadas: ${preloadedImages.length}`);
    
    preloadedImages.forEach(img => {
      console.log(`  - ${img.id}: ${img.complete ? '‚úÖ' : '‚è≥'}`);
      
      // Si ya est√° cargada, usarla directamente
      if (img.complete && img.naturalWidth > 0) {
        const type = img.id.replace('preload-', '');
        console.log(`    ‚úÖ Imagen ${type} precargada disponible (${img.naturalWidth}x${img.naturalHeight})`);
        
        // Almacenar globalmente para que est√© disponible
        window[`preloaded_${type}`] = img;
        
        // Mostrar mensaje destacado en consola
        console.log(`%c ‚úÖ SPRITE PRECARGADO DISPONIBLE: ${type} `, 'background: #080; color: white; font-size: 14px; padding: 5px;');
      }
    });
    
    if (!window.DoomGame) {
      console.error('‚ùå CR√çTICO: DoomGame no se carg√≥ correctamente');
      console.log('Verificando si game-all-in-one.js se carg√≥...');
    }
    
    // Funci√≥n para comprobar el estado de los sprites
    function checkSpriteStatus() {
      if (!window.EnemySpriteSystem) return false;
      
      // Verificar si todos los sprites est√°n cargados
      const allLoaded = !window.EnemySpriteSystem.loading && 
                        window.EnemySpriteSystem.loadedCount === window.EnemySpriteSystem.totalSprites;
      
      // Verificar cada sprite individual
      const sprites = window.EnemySpriteSystem.sprites || {};
      const spriteTypes = Object.keys(sprites);
      const loadedSprites = spriteTypes.filter(type => sprites[type] !== null);
      
      console.log(`Estado de sprites: ${allLoaded ? '‚úÖ Todos cargados' : '‚è≥ Cargando...'} (${loadedSprites.length}/${spriteTypes.length})`);
      
      // Mostrar informaci√≥n detallada de cada sprite
      spriteTypes.forEach(type => {
        const sprite = sprites[type];
        if (sprite) {
          console.log(`  ‚úÖ Sprite ${type}: Cargado correctamente`);
          // A√±adir a variables globales para debug
          window[`debug_sprite_${type}`] = sprite;
        } else {
          console.log(`  ‚ùå Sprite ${type}: No disponible`);
        }
      });
      
      // Intentar usar las im√°genes precargadas si hay alguna fallida
      if (loadedSprites.length < spriteTypes.length && window.EnemySpriteSystem.processSprite) {
        const preloadElements = document.querySelectorAll('#sprite-preload img');
        console.log(`Intentando usar ${preloadElements.length} im√°genes precargadas...`);
        
        // Verificar cada imagen precargada
        preloadElements.forEach(img => {
          if (img.complete && img.naturalWidth > 0) {
            const imgId = img.id.replace(/-\d+$/, '').replace('preload-', '');
            if (spriteTypes.includes(imgId) && !sprites[imgId]) {
              console.log(`üîÑ Utilizando imagen precargada para ${imgId}: ${img.src}`);
              sprites[imgId] = window.EnemySpriteSystem.processSprite(img, imgId);
              window.EnemySpriteSystem.loadedCount++;
              window[`preloaded_${imgId}`] = img;
            }
          }
        });
        
        // Actualizar estado de carga
        if (window.EnemySpriteSystem.loadedCount === window.EnemySpriteSystem.totalSprites) {
          window.EnemySpriteSystem.loading = false;
          console.log('‚úÖ Todos los sprites cargados (usando im√°genes precargadas)');
        }
      }
      
      // Si DoomGame est√° disponible, forzar renderizado
      if (window.DoomGame && typeof window.DoomGame.render === 'function') {
        console.log('üîÑ Forzando renderizado del juego...');
        window.DoomGame.render();
      }
      
      return allLoaded;
    }
    
    // Verificaci√≥n continua del estado de los sprites
    const spriteCheckInterval = setInterval(() => {
      const allLoaded = checkSpriteStatus();
      if (allLoaded) {
        console.log('%c ‚úÖ VERIFICACI√ìN COMPLETA: TODOS LOS SPRITES CARGADOS ', 'background: #080; color: white; font-size: 14px; padding: 5px;');
        clearInterval(spriteCheckInterval);
      }
    }, 2000);
    
    // Inspeccionar la estructura del juego
    if (window.DoomGame) {
      console.log('üîç Estructura DoomGame:');
      console.log('- M√©todo renderSprites:', typeof window.DoomGame.renderSprites === 'function' ? '‚úÖ' : '‚ùå');
      console.log('- Enemigos:', window.DoomGame.enemies ? `‚úÖ (${window.DoomGame.enemies.length})` : '‚ùå');
      
      // Verificar si hay enemigos
      if (window.DoomGame.enemies && window.DoomGame.enemies.length > 0) {
        console.log('üìä Primer enemigo:', window.DoomGame.enemies[0]);
      }
    }
    
    // Asegurar que MenuManager se inicialice correctamente
  window.addEventListener('load', () => {
      console.log('%c üéÆ JUEGO CARGADO COMPLETAMENTE ', 'background: #00a; color: white; font-size: 16px; padding: 5px;');
      console.log('üîç === VERIFICACI√ìN FINAL ===');
      console.log('- DoomGame:', !!window.DoomGame ? '‚úÖ DISPONIBLE' : '‚ùå NO DISPONIBLE');
      console.log('- EnemySpriteSystem:', !!window.EnemySpriteSystem ? '‚úÖ DISPONIBLE' : '‚ùå NO DISPONIBLE');
      
      // Verificaci√≥n final de sprites
      checkSpriteStatus();
      
      // Intentar obtener las im√°genes desde la preload
      const transferPreloadedImages = () => {
        if (!window.EnemySpriteSystem || !window.EnemySpriteSystem.sprites) return;
        
        const preloadElements = document.querySelectorAll('#sprite-preload img');
        preloadElements.forEach(img => {
          if (img.complete && img.naturalWidth > 0) {
            // Extraer el tipo de sprite del ID (quitando posibles n√∫meros)
            const imgId = img.id.replace(/-\d+$/, '').replace('preload-', '');
            if (!window.EnemySpriteSystem.sprites[imgId]) {
              console.log(`üîÑ Transfiriendo imagen precargada para ${imgId}: ${img.src}`);
              try {
                if (window.EnemySpriteSystem.processSprite) {
                  window.EnemySpriteSystem.sprites[imgId] = window.EnemySpriteSystem.processSprite(img, imgId);
                  window.EnemySpriteSystem.loadedCount++;
                }
              } catch (e) {
                console.error(`Error al procesar sprite ${imgId}:`, e);
              }
            }
          }
        });
        
        // Actualizar estado
        if (window.EnemySpriteSystem.loadedCount === window.EnemySpriteSystem.totalSprites) {
          window.EnemySpriteSystem.loading = false;
        }
        
        // Forzar renderizado
        if (window.DoomGame && typeof window.DoomGame.render === 'function') {
          window.DoomGame.render();
        }
      };
      
      // Transferir im√°genes precargadas al sistema de sprites
      transferPreloadedImages();
      
      // Programar verificaciones y renderizados adicionales
      setTimeout(transferPreloadedImages, 1000);
      setTimeout(transferPreloadedImages, 3000);
      
      // Inicializar men√∫ si es necesario
      if (window.MenuManager && !window.MenuManager.initialized) {
        console.log('üîÑ Inicializando MenuManager...');
        window.MenuManager.init();
        window.MenuManager.initialized = true;
      }
      
      // UI de depuraci√≥n opcional: crear solo si est√° habilitada
      if (ENABLE_DEBUG_PANELS) {
        const debugPanel = document.createElement('div');
        debugPanel.style.position = 'fixed';
        debugPanel.style.bottom = '10px';
        debugPanel.style.right = '10px';
        debugPanel.style.zIndex = '9999';
        debugPanel.style.backgroundColor = 'rgba(0,0,0,0.8)';
        debugPanel.style.color = 'white';
        debugPanel.style.padding = '10px';
        debugPanel.style.borderRadius = '5px';
        debugPanel.style.display = 'flex';
        debugPanel.style.flexDirection = 'column';
        debugPanel.style.gap = '5px';

        const reloadBtn = document.createElement('button');
        reloadBtn.textContent = 'üîÑ Recargar Sprites';
        reloadBtn.style.padding = '8px 12px';
        reloadBtn.style.backgroundColor = '#007bff';
        reloadBtn.style.color = 'white';
        reloadBtn.style.border = 'none';
        reloadBtn.style.borderRadius = '4px';
        reloadBtn.style.cursor = 'pointer';
        reloadBtn.onclick = function() {
          if (window.EnemySpriteSystem) {
            window.EnemySpriteSystem.loading = true;
            window.EnemySpriteSystem.loadedCount = 0;
            window.EnemySpriteSystem.errors = [];
            window.EnemySpriteSystem.init(() => {
              checkSpriteStatus();
            });
          }
          transferPreloadedImages();
        };
        debugPanel.appendChild(reloadBtn);

        const renderBtn = document.createElement('button');
        renderBtn.textContent = 'üéÆ Forzar Renderizado';
        renderBtn.style.padding = '8px 12px';
        renderBtn.style.backgroundColor = '#28a745';
        renderBtn.style.color = 'white';
        renderBtn.style.border = 'none';
        renderBtn.style.borderRadius = '4px';
        renderBtn.style.cursor = 'pointer';
        renderBtn.onclick = function() {
          if (window.DoomGame && typeof window.DoomGame.render === 'function') {
            console.log('üîÑ Forzando renderizado...');
            window.DoomGame.render();
          }
        };
        debugPanel.appendChild(renderBtn);

        const statusBtn = document.createElement('button');
        statusBtn.textContent = 'üìä Mostrar Estado';
        statusBtn.style.padding = '8px 12px';
        statusBtn.style.backgroundColor = '#ffc107';
        statusBtn.style.color = 'black';
        statusBtn.style.border = 'none';
        statusBtn.style.borderRadius = '4px';
        statusBtn.style.cursor = 'pointer';
        statusBtn.onclick = function() {
          checkSpriteStatus();
          if (window.DoomGame) {
            console.log('üìä Estado del juego:');
            console.log('- Enemigos:', window.DoomGame.enemies ? window.DoomGame.enemies.length : 'N/A');
            if (window.DoomGame.enemies && window.DoomGame.enemies.length > 0) {
              console.log('- Primer enemigo:', window.DoomGame.enemies[0]);
            }
          }
        };
        debugPanel.appendChild(statusBtn);

        document.body.appendChild(debugPanel);
      } else {
        // Limpieza defensiva: eliminar botones/overlays de render forzado si alg√∫n script los a√±adi√≥
        try {
          const demo = document.getElementById('sprite-demo-container');
          if (demo) demo.remove();
          const dbg = document.getElementById('sprite-debug-panel');
          if (dbg) dbg.remove();
          const buttons = Array.from(document.querySelectorAll('button'));
          buttons.forEach(b => {
            const t = (b.textContent || '').toLowerCase();
            if (t.includes('forzar renderizado') || t.includes('forzar render') || t.includes('recargar sprites')) {
              b.remove();
            }
          });
        } catch (e) {
          console.warn('Limpieza de botones de depuraci√≥n fall√≥:', e);
        }
      }
    });
  
  document.addEventListener('DOMContentLoaded', () => {
  const nav = typeof navigator !== 'undefined' ? navigator : null;
  const touchPoints = nav ? ((nav.maxTouchPoints || 0) + (nav.msMaxTouchPoints || 0)) : 0;
  const isTouch = ('ontouchstart' in window) || touchPoints > 0;
      const popup = document.getElementById('mouse-capture-popup');
      if (popup) {
        const icon = document.getElementById('mouse-capture-icon');
        const primary = document.getElementById('mouse-capture-primary');
        const secondary = document.getElementById('mouse-capture-secondary');
        const escapeLine = document.getElementById('mouse-capture-escape');

        if (isTouch) {
          popup.classList.add('is-touch');
          if (icon) icon.textContent = '‚òùÔ∏è';
          if (primary) primary.innerHTML = '<strong>Toca la pantalla</strong>';
          if (secondary) secondary.textContent = 'para iniciar la partida y mostrar la mira roja.';
        } else {
          popup.classList.remove('is-touch');
          if (icon) icon.textContent = 'üñ±Ô∏è';
          if (primary) primary.innerHTML = '<strong>Haz clic en la pantalla</strong>';
          if (secondary) secondary.textContent = 'para capturar el mouse y comenzar la partida.';
          if (escapeLine) escapeLine.style.display = 'block';
        }
      }

      const overlay = document.getElementById('control-hints-overlay');
      if (overlay) {
        overlay.classList.add('hidden');
        overlay.setAttribute('aria-hidden', 'true');
      }

      const qrImage = document.querySelector('.donation-qr-image');
      const lightbox = document.getElementById('donation-qr-lightbox');
      if (qrImage && lightbox) {
        const closeButton = lightbox.querySelector('[data-donation-close]');
        const lightboxImage = lightbox.querySelector('.donation-qr-lightbox__image');

        const openLightbox = () => {
          lightboxImage.src = qrImage.src;
          lightbox.classList.remove('hidden');
          lightbox.setAttribute('aria-hidden', 'false');
          if (closeButton) {
            closeButton.focus({ preventScroll: true });
          }
        };

        const closeLightbox = () => {
          if (lightbox.classList.contains('hidden')) {
            return;
          }
          lightbox.classList.add('hidden');
          lightbox.setAttribute('aria-hidden', 'true');
          if (typeof qrImage.focus === 'function') {
            qrImage.focus();
          }
        };

        qrImage.addEventListener('click', openLightbox);
        qrImage.addEventListener('keydown', event => {
          if (event.key === 'Enter' || event.key === ' ') {
            event.preventDefault();
            openLightbox();
          }
        });

        if (closeButton) {
          closeButton.addEventListener('click', closeLightbox);
        }
        lightbox.addEventListener('click', event => {
          if (event.target === lightbox) {
            closeLightbox();
          }
        });

        document.addEventListener('keydown', event => {
          if (event.key === 'Escape') {
            closeLightbox();
          }
        });
      }
    });
  </script>

</body>
</html>