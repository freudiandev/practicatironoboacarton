<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DOOM: Noboa de Cart√≥n - Juego de Disparos</title>
  
  <!-- Favicon y iconos -->
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  
  <!-- Meta tags para SEO y redes sociales -->
  <meta name="description" content="Juego estilo DOOM con laberintos, enemigos y combate en primera persona. ¬°Explora, dispara y sobrevive!">
  <meta name="keywords" content="doom, juego, fps, laberinto, disparos, javascript, canvas">
  <meta name="author" content="Alex Rafael Almeida Orellana freudianDev">
  <!-- Sugerencia de no-cache para el documento HTML (los recursos externos se versionan con ?v=) -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  
  <!-- Open Graph para redes sociales -->
  <meta property="og:title" content="DOOM: Noboa de Cart√≥n">
  <meta property="og:description" content="Juego estilo DOOM con laberintos y combate en primera persona">
  <meta property="og:type" content="website">
  <meta property="og:image" content="game-preview.png">
  
  <!-- SISTEMA DE VERSIONADO AUTOM√ÅTICO - Se ejecuta PRIMERO -->
  <script src="auto-version.js"></script>
  
  <!-- Estilos separados por funcionalidad -->
  <link rel="stylesheet" href="styles.css?v=20250818">
  <link rel="stylesheet" href="css/layout.css?v=20250818">
  <link rel="stylesheet" href="css/menus.css?v=20250818">
  <link rel="stylesheet" href="css/game-ui.css?v=20250818">
  <link rel="stylesheet" href="css/effects.css?v=20250818">
  <!-- Estilos para m√≥vil y responsive avanzado -->
  <link rel="stylesheet" href="css/mobile.css?v=20250818">
</head>
<body>
  <!-- Men√∫ de inicio -->
  <div id="main-menu" class="menu-screen">
    <div class="menu-bunting" aria-hidden="true"></div>
    <div class="menu-backdrop-texture" aria-hidden="true"></div>
    <div class="menu-container">
      <div class="pins" aria-hidden="true"></div>
      <h1 class="game-title">DOOM: Noboa de Cart√≥n</h1>
      <div class="menu-buttons">
        <button id="start-btn" class="menu-btn">INICIAR PARTIDA</button>
        <button id="highscores-btn" class="menu-btn">PUNTAJES M√ÅS ALTOS</button>
        <button id="donate-btn" class="menu-btn">DONACIONES</button>
      </div>
    </div>
  </div>

  <!-- Pantalla de puntajes -->
  <div id="highscores-screen" class="menu-screen hidden">
    <div class="menu-container">
      <h1 class="game-title">MEJORES PUNTAJES</h1>
      <div id="highscores-list" class="highscores-list">
        <!-- Los puntajes se cargar√°n aqu√≠ -->
      </div>
      <button id="back-to-menu-btn" class="menu-btn">VOLVER AL MEN√ö</button>
    </div>
  </div>

  <!-- Pantalla de juego -->
  <div id="game-screen" class="hidden">
    <!-- HUD del juego mejorado -->
    <div id="game-hud">
      <div class="hud-item">
        <span class="hud-label">TIEMPO:</span>
        <span id="timer-display" class="hud-value">0:00</span>
      </div>
      <div class="hud-item">
        <span class="hud-label">KILLS:</span>
        <span id="kills-display" class="hud-value">0</span>
      </div>
      <div class="hud-item">
        <span class="hud-label">ENEMIGOS:</span>
        <span id="enemy-count" class="hud-value">0</span>
      </div>
      <div class="hud-item">
        <span class="hud-label">PUNTOS:</span>
        <span id="score-display" class="hud-value">0</span>
      </div>
      <div class="hud-item">
        <span class="hud-label">VIDA:</span>
        <span id="health-display" class="hud-value">100</span>
      </div>
      <div class="hud-item">
        <span class="hud-label">HEADSHOTS:</span>
        <span id="headshot-counter" class="hud-value">0</span>
      </div>
    </div>
    
    <!-- Popup de captura de mouse -->
    <div id="mouse-capture-popup" class="mouse-capture-popup">
      <h3>üéØ DOOM: Noboa de Cart√≥n</h3>
      <div class="click-icon">üñ±Ô∏è</div>
      <p><strong>Haz clic en la pantalla</strong></p>
      <p>para capturar el mouse y comenzar a jugar</p>
    </div>
    
    <!-- Layout del juego -->
    <div class="game-layout-improved">
      <!-- Container del juego -->
      <div id="game-container"></div>
      
      <!-- Panel derecho mejorado -->
      <aside class="right-panel-improved">
        <h3>üéÆ Controles</h3>
        <p><strong>WASD:</strong> Movimiento</p>
        <p><strong>Mouse:</strong> Mirar</p>
        <p><strong>Click:</strong> Disparar</p>
        <p><strong>R:</strong> Recargar</p>
        <p><strong>‚Üê ‚Üí:</strong> Girar</p>
        <p><strong>‚Üë ‚Üì:</strong> Mirar arriba/abajo</p>
        <p><strong>ESC:</strong> Men√∫</p>
        
        <h3>üéØ Objetivos</h3>
        <p>‚Ä¢ Elimina todos los enemigos</p>
        <p>‚Ä¢ Recoge munici√≥n (dorado)</p>
        <p>‚Ä¢ Recoge vida (rojo)</p>
        <p>‚Ä¢ Explora la casa-laberinto</p>
        
        <h3>üìä Estado</h3>
        <div class="status-bar">
          <div class="status-item">
            <span>Vida:</span>
            <div class="health-bar">
              <div id="health-bar-fill" class="health-bar-fill"></div>
            </div>
          </div>
          <div class="status-item">
            <span>Munici√≥n:</span>
            <span id="ammo-display">30/30</span>
          </div>
        </div>
      </aside>
    </div>

    <!-- Controles m√≥viles (aparecen solo en dispositivos t√°ctiles) -->
    <div id="mobile-controls" aria-label="Controles t√°ctiles" class="hidden" role="group">
      <div class="mc-left">
        <button class="mc-btn mc-w" data-key="KeyW" aria-label="Avanzar">W</button>
        <div class="mc-row">
          <button class="mc-btn mc-a" data-key="KeyA" aria-label="Izquierda">A</button>
          <button class="mc-btn mc-s" data-key="KeyS" aria-label="Atr√°s">S</button>
          <button class="mc-btn mc-d" data-key="KeyD" aria-label="Derecha">D</button>
        </div>
      </div>
      <div class="mc-right">
        <div class="mc-row">
          <button class="mc-btn mc-up" data-key="ArrowUp" aria-label="Cabeza arriba">‚Üë</button>
        </div>
        <div class="mc-row">
          <button class="mc-btn mc-left" data-key="ArrowLeft" aria-label="Cabeza izquierda">‚Üê</button>
          <button class="mc-btn mc-right" data-key="ArrowRight" aria-label="Cabeza derecha">‚Üí</button>
        </div>
        <div class="mc-row">
          <button class="mc-btn mc-down" data-key="ArrowDown" aria-label="Cabeza abajo">‚Üì</button>
        </div>
      </div>
      <button id="mc-shot" class="mc-shot" aria-label="Disparar">SHOT</button>
    </div>

    <!-- Overlay para rotar dispositivo a horizontal -->
    <div id="rotate-overlay" class="hidden" aria-live="assertive">
      <div class="rotate-card">
        <div class="rotate-icon">üì±‚Üª</div>
        <div class="rotate-text">Gira tu dispositivo a horizontal para jugar</div>
      </div>
    </div>
  </div>

  <!-- Precarga de sprites antes de iniciar el juego -->
  <div id="sprite-preload" style="position: fixed; left: -9999px; top: -9999px; visibility: hidden;">
    <!-- Cargar sprites desde la ra√≠z del proyecto -->
    <img src="noboa-casual.png?v=20250818" alt="Sprite casual" id="preload-casual">
    <img src="noboa-deportivo.png?v=20250818" alt="Sprite deportivo" id="preload-deportivo">
    <img src="noboa-presidencial.png?v=20250818" alt="Sprite presidencial" id="preload-presidencial">
  </div>

  <!-- SCRIPTS - ORDEN CR√çTICO CON DEBUG -->
  <!-- Definir versi√≥n global de assets antes de cualquier script -->
  <script>window.__ASSET_VERSION__ = '20250818';</script>
  <!-- Solo cargar el sistema de sprites necesario en producci√≥n -->
  <script src="enemy-sprites.js?v=20250818"></script>
  
  <!-- Sistemas de armas: efectos de balas y audio -->
  <script src="bullet-effects.js?v=20250818"></script>
  <script src="weapon-audio.js?v=20250818"></script>
  
  <!-- Test inmediato de sistemas de armas -->
  <script>
    console.log('üß™ Testeo inmediato de sistemas de armas...');
    console.log('BulletEffectsSystem:', typeof BulletEffectsSystem);
    console.log('WeaponAudioSystem:', typeof WeaponAudioSystem);
    
    // Test r√°pido de instanciaci√≥n
    try {
      const testBullets = new BulletEffectsSystem();
      console.log('‚úÖ BulletEffectsSystem instanciado correctamente');
    } catch (e) {
      console.error('‚ùå Error instanciando BulletEffectsSystem:', e);
    }
    
    try {
      const testAudio = new WeaponAudioSystem();
      console.log('‚úÖ WeaponAudioSystem instanciado correctamente');
    } catch (e) {
      console.error('‚ùå Error instanciando WeaponAudioSystem:', e);
    }
  </script>
  
  <!-- Carga condicional de utilidades de debug (deshabilitado por defecto) -->
  <script>
  window.__DEBUG_MODE__ = false; // Cambiar a true solo para depurar localmente
    if (window.__DEBUG_MODE__) {
      [
        'sprite-loader.js',
        'debug-system.js',
        'sprite-fixer.js',
        'sprite-tester.js',
        'doom-inspector.js'
      ].forEach(function(src) {
        var s = document.createElement('script');
    s.src = src + '?v=' + window.__ASSET_VERSION__;
        document.head.appendChild(s);
      });
    }
  </script>
  <!-- Luego cargar el juego y sus componentes -->
  <script src="game-all-in-one.js?v=20250818"></script>
  <script src="menu-manager.js?v=20250818"></script>
  <!-- Responsive y controles m√≥viles -->
  <script src="responsive.js?v=20250818"></script>
  <script src="mobile-controls.js?v=20250818"></script>

  <!-- Verificaci√≥n mejorada -->
  <script>
    console.log('üîç === VERIFICACI√ìN DE SISTEMAS ===');
  // Flag global para UI de depuraci√≥n (botones flotantes)
  const ENABLE_DEBUG_PANELS = false;
    
    // Verificaci√≥n de componentes cr√≠ticos
    console.log('- DoomGame disponible:', !!window.DoomGame ? '‚úÖ' : '‚ùå');
    console.log('- MenuManager disponible:', !!window.MenuManager ? '‚úÖ' : '‚ùå');
    console.log('- EnemySpriteSystem disponible:', !!window.EnemySpriteSystem ? '‚úÖ' : '‚ùå');
    console.log('- Precarga de sprites:', !!document.getElementById('sprite-preload') ? '‚úÖ' : '‚ùå');
    
    // Verificar si los elementos precargados se cargaron correctamente
    const preloadedImages = document.querySelectorAll('#sprite-preload img');
    console.log(`- Im√°genes precargadas: ${preloadedImages.length}`);
    
    preloadedImages.forEach(img => {
      console.log(`  - ${img.id}: ${img.complete ? '‚úÖ' : '‚è≥'}`);
      
      // Si ya est√° cargada, usarla directamente
      if (img.complete && img.naturalWidth > 0) {
        const type = img.id.replace('preload-', '');
        console.log(`    ‚úÖ Imagen ${type} precargada disponible (${img.naturalWidth}x${img.naturalHeight})`);
        
        // Almacenar globalmente para que est√© disponible
        window[`preloaded_${type}`] = img;
        
        // Mostrar mensaje destacado en consola
        console.log(`%c ‚úÖ SPRITE PRECARGADO DISPONIBLE: ${type} `, 'background: #080; color: white; font-size: 14px; padding: 5px;');
      }
    });
    
    if (!window.DoomGame) {
      console.error('‚ùå CR√çTICO: DoomGame no se carg√≥ correctamente');
      console.log('Verificando si game-all-in-one.js se carg√≥...');
    }
    
    // Funci√≥n para comprobar el estado de los sprites
    function checkSpriteStatus() {
      if (!window.EnemySpriteSystem) return false;
      
      // Verificar si todos los sprites est√°n cargados
      const allLoaded = !window.EnemySpriteSystem.loading && 
                        window.EnemySpriteSystem.loadedCount === window.EnemySpriteSystem.totalSprites;
      
      // Verificar cada sprite individual
      const sprites = window.EnemySpriteSystem.sprites || {};
      const spriteTypes = Object.keys(sprites);
      const loadedSprites = spriteTypes.filter(type => sprites[type] !== null);
      
      console.log(`Estado de sprites: ${allLoaded ? '‚úÖ Todos cargados' : '‚è≥ Cargando...'} (${loadedSprites.length}/${spriteTypes.length})`);
      
      // Mostrar informaci√≥n detallada de cada sprite
      spriteTypes.forEach(type => {
        const sprite = sprites[type];
        if (sprite) {
          console.log(`  ‚úÖ Sprite ${type}: Cargado correctamente`);
          // A√±adir a variables globales para debug
          window[`debug_sprite_${type}`] = sprite;
        } else {
          console.log(`  ‚ùå Sprite ${type}: No disponible`);
        }
      });
      
      // Intentar usar las im√°genes precargadas si hay alguna fallida
      if (loadedSprites.length < spriteTypes.length && window.EnemySpriteSystem.processSprite) {
        const preloadElements = document.querySelectorAll('#sprite-preload img');
        console.log(`Intentando usar ${preloadElements.length} im√°genes precargadas...`);
        
        // Verificar cada imagen precargada
        preloadElements.forEach(img => {
          if (img.complete && img.naturalWidth > 0) {
            const imgId = img.id.replace(/-\d+$/, '').replace('preload-', '');
            if (spriteTypes.includes(imgId) && !sprites[imgId]) {
              console.log(`üîÑ Utilizando imagen precargada para ${imgId}: ${img.src}`);
              sprites[imgId] = window.EnemySpriteSystem.processSprite(img, imgId);
              window.EnemySpriteSystem.loadedCount++;
              window[`preloaded_${imgId}`] = img;
            }
          }
        });
        
        // Actualizar estado de carga
        if (window.EnemySpriteSystem.loadedCount === window.EnemySpriteSystem.totalSprites) {
          window.EnemySpriteSystem.loading = false;
          console.log('‚úÖ Todos los sprites cargados (usando im√°genes precargadas)');
        }
      }
      
      // Si DoomGame est√° disponible, forzar renderizado
      if (window.DoomGame && typeof window.DoomGame.render === 'function') {
        console.log('üîÑ Forzando renderizado del juego...');
        window.DoomGame.render();
      }
      
      return allLoaded;
    }
    
    // Verificaci√≥n continua del estado de los sprites
    const spriteCheckInterval = setInterval(() => {
      const allLoaded = checkSpriteStatus();
      if (allLoaded) {
        console.log('%c ‚úÖ VERIFICACI√ìN COMPLETA: TODOS LOS SPRITES CARGADOS ', 'background: #080; color: white; font-size: 14px; padding: 5px;');
        clearInterval(spriteCheckInterval);
      }
    }, 2000);
    
    // Inspeccionar la estructura del juego
    if (window.DoomGame) {
      console.log('üîç Estructura DoomGame:');
      console.log('- M√©todo renderSprites:', typeof window.DoomGame.renderSprites === 'function' ? '‚úÖ' : '‚ùå');
      console.log('- Enemigos:', window.DoomGame.enemies ? `‚úÖ (${window.DoomGame.enemies.length})` : '‚ùå');
      
      // Verificar si hay enemigos
      if (window.DoomGame.enemies && window.DoomGame.enemies.length > 0) {
        console.log('üìä Primer enemigo:', window.DoomGame.enemies[0]);
      }
    }
    
    // Asegurar que MenuManager se inicialice correctamente
  window.addEventListener('load', () => {
      console.log('%c üéÆ JUEGO CARGADO COMPLETAMENTE ', 'background: #00a; color: white; font-size: 16px; padding: 5px;');
      console.log('üîç === VERIFICACI√ìN FINAL ===');
      console.log('- DoomGame:', !!window.DoomGame ? '‚úÖ DISPONIBLE' : '‚ùå NO DISPONIBLE');
      console.log('- EnemySpriteSystem:', !!window.EnemySpriteSystem ? '‚úÖ DISPONIBLE' : '‚ùå NO DISPONIBLE');
      
      // Verificaci√≥n final de sprites
      checkSpriteStatus();
      
      // Intentar obtener las im√°genes desde la preload
      const transferPreloadedImages = () => {
        if (!window.EnemySpriteSystem || !window.EnemySpriteSystem.sprites) return;
        
        const preloadElements = document.querySelectorAll('#sprite-preload img');
        preloadElements.forEach(img => {
          if (img.complete && img.naturalWidth > 0) {
            // Extraer el tipo de sprite del ID (quitando posibles n√∫meros)
            const imgId = img.id.replace(/-\d+$/, '').replace('preload-', '');
            if (!window.EnemySpriteSystem.sprites[imgId]) {
              console.log(`üîÑ Transfiriendo imagen precargada para ${imgId}: ${img.src}`);
              try {
                if (window.EnemySpriteSystem.processSprite) {
                  window.EnemySpriteSystem.sprites[imgId] = window.EnemySpriteSystem.processSprite(img, imgId);
                  window.EnemySpriteSystem.loadedCount++;
                }
              } catch (e) {
                console.error(`Error al procesar sprite ${imgId}:`, e);
              }
            }
          }
        });
        
        // Actualizar estado
        if (window.EnemySpriteSystem.loadedCount === window.EnemySpriteSystem.totalSprites) {
          window.EnemySpriteSystem.loading = false;
        }
        
        // Forzar renderizado
        if (window.DoomGame && typeof window.DoomGame.render === 'function') {
          window.DoomGame.render();
        }
      };
      
      // Transferir im√°genes precargadas al sistema de sprites
      transferPreloadedImages();
      
      // Programar verificaciones y renderizados adicionales
      setTimeout(transferPreloadedImages, 1000);
      setTimeout(transferPreloadedImages, 3000);
      
      // Inicializar men√∫ si es necesario
      if (window.MenuManager && !window.MenuManager.initialized) {
        console.log('üîÑ Inicializando MenuManager...');
        window.MenuManager.init();
        window.MenuManager.initialized = true;
      }
      
      // UI de depuraci√≥n opcional: crear solo si est√° habilitada
      if (ENABLE_DEBUG_PANELS) {
        const debugPanel = document.createElement('div');
        debugPanel.style.position = 'fixed';
        debugPanel.style.bottom = '10px';
        debugPanel.style.right = '10px';
        debugPanel.style.zIndex = '9999';
        debugPanel.style.backgroundColor = 'rgba(0,0,0,0.8)';
        debugPanel.style.color = 'white';
        debugPanel.style.padding = '10px';
        debugPanel.style.borderRadius = '5px';
        debugPanel.style.display = 'flex';
        debugPanel.style.flexDirection = 'column';
        debugPanel.style.gap = '5px';

        const reloadBtn = document.createElement('button');
        reloadBtn.textContent = 'üîÑ Recargar Sprites';
        reloadBtn.style.padding = '8px 12px';
        reloadBtn.style.backgroundColor = '#007bff';
        reloadBtn.style.color = 'white';
        reloadBtn.style.border = 'none';
        reloadBtn.style.borderRadius = '4px';
        reloadBtn.style.cursor = 'pointer';
        reloadBtn.onclick = function() {
          if (window.EnemySpriteSystem) {
            window.EnemySpriteSystem.loading = true;
            window.EnemySpriteSystem.loadedCount = 0;
            window.EnemySpriteSystem.errors = [];
            window.EnemySpriteSystem.init(() => {
              checkSpriteStatus();
            });
          }
          transferPreloadedImages();
        };
        debugPanel.appendChild(reloadBtn);

        const renderBtn = document.createElement('button');
        renderBtn.textContent = 'üéÆ Forzar Renderizado';
        renderBtn.style.padding = '8px 12px';
        renderBtn.style.backgroundColor = '#28a745';
        renderBtn.style.color = 'white';
        renderBtn.style.border = 'none';
        renderBtn.style.borderRadius = '4px';
        renderBtn.style.cursor = 'pointer';
        renderBtn.onclick = function() {
          if (window.DoomGame && typeof window.DoomGame.render === 'function') {
            console.log('üîÑ Forzando renderizado...');
            window.DoomGame.render();
          }
        };
        debugPanel.appendChild(renderBtn);

        const statusBtn = document.createElement('button');
        statusBtn.textContent = 'üìä Mostrar Estado';
        statusBtn.style.padding = '8px 12px';
        statusBtn.style.backgroundColor = '#ffc107';
        statusBtn.style.color = 'black';
        statusBtn.style.border = 'none';
        statusBtn.style.borderRadius = '4px';
        statusBtn.style.cursor = 'pointer';
        statusBtn.onclick = function() {
          checkSpriteStatus();
          if (window.DoomGame) {
            console.log('üìä Estado del juego:');
            console.log('- Enemigos:', window.DoomGame.enemies ? window.DoomGame.enemies.length : 'N/A');
            if (window.DoomGame.enemies && window.DoomGame.enemies.length > 0) {
              console.log('- Primer enemigo:', window.DoomGame.enemies[0]);
            }
          }
        };
        debugPanel.appendChild(statusBtn);

        document.body.appendChild(debugPanel);
      } else {
        // Limpieza defensiva: eliminar botones/overlays de render forzado si alg√∫n script los a√±adi√≥
        try {
          const demo = document.getElementById('sprite-demo-container');
          if (demo) demo.remove();
          const dbg = document.getElementById('sprite-debug-panel');
          if (dbg) dbg.remove();
          const buttons = Array.from(document.querySelectorAll('button'));
          buttons.forEach(b => {
            const t = (b.textContent || '').toLowerCase();
            if (t.includes('forzar renderizado') || t.includes('forzar render') || t.includes('recargar sprites')) {
              b.remove();
            }
          });
        } catch (e) {
          console.warn('Limpieza de botones de depuraci√≥n fall√≥:', e);
        }
      }
    });
  </script>

</body>
</html>